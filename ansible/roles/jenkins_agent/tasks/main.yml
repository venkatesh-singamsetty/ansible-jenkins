---
# Role: jenkins_agent
# Purpose: install and configure Jenkins agent services
# Notes: variables are provided via `defaults/` and `inventories/group_vars`

- name: Ensure apt cache is up to date
  ansible.builtin.apt:
    update_cache: true
  when: ansible_facts['pkg_mgr'] == 'apt'

- name: Install Java runtime (agent)
  ansible.builtin.package:
    name: "{{ jenkins_agent_java_package | default(java_package) }}"
    state: present

- name: Ensure agent user exists
  ansible.builtin.user:
    name: "{{ jenkins_agent_user | default(agent_user) }}"
    system: true
    create_home: false

- name: Create agent work directory
  ansible.builtin.file:
    path: "{{ jenkins_agent_workdir | default(agent_workdir) }}"
    owner: "{{ jenkins_agent_user | default(agent_user) }}"
    group: "{{ jenkins_agent_group | default(agent_group) }}"
    state: directory
    mode: '0755'

- name: Create agent install directory
  ansible.builtin.file:
    path: "{{ jenkins_agent_jar_path | default(agent_jar_path) }}"
    owner: "{{ jenkins_agent_user | default(agent_user) }}"
    group: "{{ jenkins_agent_group | default(agent_group) }}"
    state: directory
    mode: '0755'

- name: Download Jenkins agent jar
  ansible.builtin.get_url:
    url: "{{ controller_url | default('http://localhost:8080') }}/jnlpJars/agent.jar"
    dest: "{{ (jenkins_agent_jar_path | default(agent_jar_path)) }}/{{ jenkins_agent_jar | default(agent_jar) }}"
    mode: '0755'
  register: agent_jar_download
  until: agent_jar_download is succeeded
  retries: 3
  delay: 10

- name: Deploy agent systemd unit
  ansible.builtin.template:
    src: agent.service.j2
    dest: "/etc/systemd/system/{{ jenkins_agent_service_name | default(agent_service_name) }}.service"
    mode: '0644'
  notify: Restart Jenkins Agent
